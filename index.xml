<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Processador XML NFe - XLSX</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
        }
        h1 { font-size: 22px; margin-bottom: 10px; }
        .card {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 14px;
            cursor: pointer;
        }
        .log {
            font-size: 13px;
            white-space: pre-wrap;
            background: #f7f7f7;
            padding: 10px;
            border-radius: 4px;
            max-height: 220px;
            overflow-y: auto;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

    <h1>Processador XML NFe (Web XLSX)</h1>

    <div class="card">
        <p>Selecione um ou mais arquivos .xml de NFe:</p>

        <!-- IMPORTANTE: atributo multiple com valor -->
        <input type="file" id="xmlFiles" accept=".xml" multiple="multiple">

        <br><br>
        <button id="btnProcessar">Processar XMLs e gerar XLSX</button>
    </div>

    <div class="card">
        <h3>Status / Log</h3>
        <div id="log" class="log"></div>
    </div>

<script>
const logEl = document.getElementById('log');
const btnProcessar = document.getElementById('btnProcessar');
const inputFiles = document.getElementById('xmlFiles');

function log(msg) { logEl.textContent += msg + "\n"; }
function limparLog() { logEl.textContent = ""; }

function getText(parent, tagName) {
    if (!parent) return "";
    const els = parent.getElementsByTagName(tagName);
    if (!els.length) return "";
    return (els[0].textContent || "").trim();
}

function adicionarAoResumo(mapResumo, codProd, nomeProd, unidade, qtd) {
    const chave = codProd + "|" + unidade;
    if (mapResumo.has(chave)) {
        mapResumo.get(chave).quantidade += qtd;
    } else {
        mapResumo.set(chave, {
            codProd, nomeProd, unidade, quantidade: qtd
        });
    }
}

btnProcessar.addEventListener('click', async () => {
    limparLog();

    const files = inputFiles.files;
    if (!files.length) {
        log("Nenhum XML selecionado.");
        return;
    }

    log(Processando ${files.length} arquivo(s)...);

    const relatorio = [["Nota","Volumes","Peso","Destinatário","Endereço","Cidade"]];
    const resumo = new Map();

    let totalNotas = 0, totalVolumes = 0, totalPeso = 0;
    const parser = new DOMParser();

    for (const file of files) {
        try {
            const xml = await file.text();
            const doc = parser.parseFromString(xml,"application/xml");

            const inf = doc.getElementsByTagName("infNFe")[0];
            if (!inf) { log(Erro: infNFe não encontrado em ${file.name}); continue; }

            const ide = inf.getElementsByTagName("ide")[0];
            const numero = getText(ide,"nNF");

            let volumes = 0, peso = 0;
            const transp = inf.getElementsByTagName("transp")[0];
            if (transp) {
                const vol = transp.getElementsByTagName("vol")[0];
                if (vol) {
                    volumes = parseFloat(getText(vol,"qVol").replace(",",".") ) || 0;
                    peso    = parseFloat(getText(vol,"pesoB").replace(",",".") ) || 0;
                }
            }

            const dest = inf.getElementsByTagName("dest")[0];
            const nome = dest ? getText(dest,"xNome") : "";
            let end = "", cid = "";

            if (dest) {
                const ent = dest.getElementsByTagName("enderDest")[0];
                if (ent) {
                    end = ${getText(ent,"xLgr")}, ${getText(ent,"nro")};
                    cid = getText(ent,"xMun");
                }
            }

            relatorio.push([numero, volumes, peso, nome, end, cid]);

            totalNotas++;
            totalVolumes += volumes;
            totalPeso += peso;

            const dets = inf.getElementsByTagName("det");
            for (const d of dets) {
                const prod = d.getElementsByTagName("prod")[0];
                if (!prod) continue;

                const cod = getText(prod,"cProd");
                const nomeProd = getText(prod,"xProd");
                const un = getText(prod,"uCom");
                const q = parseFloat(getText(prod,"qCom").replace(",",".") ) || 0;

                adicionarAoResumo(resumo,cod,nomeProd,un,q);
            }

            log(OK: ${file.name});

        } catch (e) {
            log(Erro no arquivo ${file.name}: ${e});
        }
    }

    relatorio.push([]);
    relatorio.push(["TOTAL DE NOTAS:", totalNotas]);
    relatorio.push(["TOTAL DE VOLUMES:", totalVolumes]);
    relatorio.push(["TOTAL DE PESO:", totalPeso]);

    const resumoArr = [["Código","Produto","Unidade","Quantidade"]];
    for (const [k,item] of resumo) {
        resumoArr.push([item.codProd,item.nomeProd,item.unidade,item.quantidade]);
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(relatorio), "Relatorio");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumoArr), "ResumoProduto");

    XLSX.writeFile(wb, "Relatorio_NFe.xlsx");
    log("\nArquivo XLSX gerado!");
});
</script>

</body>
</html>
