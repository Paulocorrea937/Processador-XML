<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Processador XML NFe - XLSX</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
        }
        h1 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        .card {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 14px;
            cursor: pointer;
        }
        .log {
            font-size: 13px;
            white-space: pre-wrap;
            background: #f7f7f7;
            padding: 10px;
            border-radius: 4px;
            max-height: 220px;
            overflow-y: auto;
        }
    </style>

    <!-- Biblioteca XLSX para gerar o arquivo do Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

    <h1>Processador XML NFe (Web XLSX)</h1>

    <div class="card">
        <p>Selecione um ou mais arquivos .xml de NFe:</p>

        <input type="file" id="xmlFiles" accept=".xml" multiple="multiple">

        <br><br>
        <button id="btnProcessar">Processar XMLs e gerar XLSX</button>
    </div>

    <div class="card">
        <h3>Status / Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
    (function () {
      const logEl = document.getElementById('log');
      const btnProcessar = document.getElementById('btnProcessar');
      const inputFiles = document.getElementById('xmlFiles');

      function log(msg) {
        logEl.textContent += msg + "\n";
      }

      function limparLog() {
        logEl.textContent = "";
      }

      function getText(parent, tagName) {
        if (!parent) return "";
        const els = parent.getElementsByTagName(tagName);
        if (!els.length) return "";
        return (els[0].textContent || "").trim();
      }

      function adicionarAoResumo(mapResumo, codProd, nomeProd, unidade, qtd) {
        const chave = codProd + "|" + unidade;
        if (mapResumo.has(chave)) {
          mapResumo.get(chave).quantidade += qtd;
        } else {
          mapResumo.set(chave, {
            codProd: codProd,
            nomeProd: nomeProd,
            unidade: unidade,
            quantidade: qtd
          });
        }
      }

      btnProcessar.addEventListener('click', async function () {
        limparLog();
        log("Botão clicado. Iniciando processamento...");

        if (typeof XLSX === "undefined") {
          alert("Erro: biblioteca XLSX não carregou. Verifique sua conexão e recarregue a página.");
          log("Erro: objeto XLSX está indefinido.");
          return;
        }

        const files = inputFiles.files;
        if (!files || !files.length) {
          log("Nenhum XML selecionado.");
          alert("Selecione pelo menos um arquivo XML.");
          return;
        }

        log("Arquivos selecionados: " + files.length);

        const relatorio = [["Nota", "Volumes", "Peso", "Destinatário", "Endereço", "Cidade"]];
        const resumo = new Map();

        let totalNotas = 0;
        let totalVolumes = 0;
        let totalPeso = 0;

        const parser = new DOMParser();

        for (const file of files) {
          try {
            log("Lendo arquivo: " + file.name);
            const xml = await file.text();
            const doc = parser.parseFromString(xml, "application/xml");

            const inf = doc.getElementsByTagName("infNFe")[0];
            if (!inf) {
              log("infNFe não encontrado em " + file.name);
              continue;
