<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Processador XML NFe - XLSX</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
        }
        h1 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        .card {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 14px;
            cursor: pointer;
        }
        .log {
            font-size: 13px;
            white-space: pre-wrap;
            background: #f7f7f7;
            padding: 10px;
            border-radius: 4px;
            max-height: 220px;
            overflow-y: auto;
        }
    </style>

    <!-- Biblioteca XLSX para gerar o arquivo do Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

    <h1>Processador XML NFe (Web XLSX)</h1>

    <div class="card">
        <p>Selecione um ou mais arquivos .xml de NFe:</p>

        <input type="file" id="xmlFiles" accept=".xml" multiple="multiple">

        <br><br>
        <button id="btnProcessar">Processar XMLs e gerar XLSX</button>
    </div>

    <div class="card">
        <h3>Status / Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
    // ---- Funções utilitárias ----
    function getLogElement() {
        return document.getElementById("log");
    }

    function log(msg) {
        var el = getLogElement();
        el.textContent += msg + "\n";
    }

    function limparLog() {
        var el = getLogElement();
        el.textContent = "";
    }

    function getText(parent, tagName) {
        if (!parent) return "";
        var els = parent.getElementsByTagName(tagName);
        if (!els || !els.length) return "";
        var t = els[0].textContent || "";
        return t.replace(/\s+/g, " ").replace(/^\s+|\s+$/g, "");
    }

    // resumo[chave] = { codProd, nomeProd, unidade, quantidade }
    function adicionarAoResumo(resumo, codProd, nomeProd, unidade, qtd) {
        var chave = codProd + "|" + unidade;
        if (resumo[chave]) {
            resumo[chave].quantidade += qtd;
        } else {
            resumo[chave] = {
                codProd: codProd,
                nomeProd: nomeProd,
                unidade: unidade,
                quantidade: qtd
            };
        }
    }

    function processarXmlTexto(xmlTexto, nomeArquivo, relatorio, resumo, totais) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(xmlTexto, "application/xml");

        var inf = doc.getElementsByTagName("infNFe")[0];
        if (!inf) {
            log("infNFe não encontrado em " + nomeArquivo);
            return;
        }

        var ide = inf.getElementsByTagName("ide")[0];
        var numero = getText(ide, "nNF");

        var volumes = 0;
        var peso = 0;
        var transp = inf.getElementsByTagName("transp")[0];
        if (transp) {
            var vol = transp.getElementsByTagName("vol")[0];
            if (vol) {
                var qVolStr = getText(vol, "qVol").replace(",", ".");
                var pesoStr = getText(vol, "pesoB").replace(",", ".");
                volumes = qVolStr ? parseFloat(qVolStr) : 0;
                peso = pesoStr ? parseFloat(pesoStr) : 0;
            }
        }

        var dest = inf.getElementsByTagName("dest")[0];
        var nomeDest = dest ? getText(dest, "xNome") : "";
        var end = "";
        var cid = "";

        if (dest) {
            var ent = dest.getElementsByTagName("enderDest")[0];
            if (ent) {
                var xLgr = getText(ent, "xLgr");
                var nro = getText(ent, "nro");
                end = (xLgr || "") + (nro ? ", " + nro : "");
                cid = getText(ent, "xMun");
            }
        }

        relatorio.push([numero, volumes, peso, nomeDest, end, cid]);

        totais.totalNotas += 1;
        totais.totalVolumes += volumes;
        totais.totalPeso += peso;

        var dets = inf.getElementsByTagName("det");
        for (var i = 0; i < dets.length; i++) {
            var prod = dets[i].getElementsByTagName("prod")[0];
            if (!prod) continue;

            var cod = getText(prod, "cProd");
            var nomeProd = getText(prod, "xProd");
            var un = getText(prod, "uCom");
            var qStr = getText(prod, "qCom").replace(",", ".");
            var q = qStr ? parseFloat(qStr) : 0;

            adicionarAoResumo(resumo, cod, nomeProd, un, q);
        }

        log("OK: " + nomeArquivo);
    }

    function gerarExcel(relatorio, resumo, totais) {
        relatorio.push([]);
        relatorio.push(["TOTAL DE NOTAS:", totais.totalNotas]);
        relatorio.push(["TOTAL DE VOLUMES:", totais.totalVolumes]);
        relatorio.push(["TOTAL DE PESO:", totais.totalPeso]);

        var resumoArr = [["Código", "Produto", "Unidade", "Quantidade"]];
        for (var chave in resumo) {
            if (!resumo.hasOwnProperty(chave)) continue;
            var item = resumo[chave];
            resumoArr.push([item.codProd, item.nomeProd, item.unidade, item.quantidade]);
        }

        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(relatorio), "Relatorio");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumoArr), "ResumoProduto");
        XLSX.writeFile(wb, "Relatorio_NFe.xlsx");
    }

    // ---- Inicialização / Clique do botão ----
    window.onload = function () {
        var btn = document.getElementById("btnProcessar");
        var input = document.getElementById("xmlFiles");

        btn.onclick = function () {
            limparLog();
            log("Botão clicado.");

            if (typeof XLSX === "undefined") {
                alert("Erro: biblioteca XLSX não carregou. Verifique sua conexão e recarregue a página.");
                log("Erro: XLSX indefinido.");
                return;
            }

            var files = input.files;
            if (!files || !files.length) {
                log("Nenhum XML selecionado.");
                alert("Selecione pelo menos um arquivo XML.");
                return;
            }

            log("Arquivos selecionados: " + files.length);

            var relatorio = [["Nota", "Volumes", "Peso", "Destinatário", "Endereço", "Cidade"]];
            var resumo = {};
            var totais = { totalNotas: 0, totalVolumes: 0, totalPeso: 0 };

            var qtdArquivos = files.length;
            var processados = 0;

            for (var i = 0; i < files.length; i++) {
                (function (file) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            var texto = e.target.result;
                            processarXmlTexto(texto, file.name, relatorio, resumo, totais);
                        } catch (erro) {
                            log("Erro ao processar " + file.name + ": " + erro);
                        }
                        processados++;
                        if (processados === qtdArquivos) {
                            log("Todos os arquivos lidos. Gerando XLSX...");
                            try {
                                gerarExcel(relatorio, resumo, totais);
                                log("Arquivo XLSX gerado com sucesso.");
                                alert("Pronto! O arquivo Relatorio_NFe.xlsx foi gerado. Confira na pasta de downloads.");
                            } catch (erro2) {
                                log("Erro ao gerar XLSX: " + erro2);
                                alert("Erro ao gerar o XLSX. Veja o log na tela.");
                            }
                        }
                    };
                    reader.onerror = function () {
                        log("Erro de leitura no arquivo " + file.name);
                        processados++;
                    };
                    reader.readAsText(file);
                })(files[i]);
            }
        };
    };
    </script>

</body>
</html>
